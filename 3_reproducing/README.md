# 3️⃣ 데이터 활용 및 분석 : **머신러닝 라이브러리를 이용한 재현 가능한 개발 결과물 공개 여부**

## Summary
본 연구의 모델 **추론–평가** 파이프라인은 **PyTorch** 기반으로 구현되었으며, 전 과정을 스크립트로 자동화했습니다.  
재현성을 위해 동일 환경 구축 방법을 **[2_setup](https://github.com/Coffeeloveman/technical-portfolio/tree/main/2_setup)**에 공개했고, 제공된 명령만으로 동일한 추론·평가를 수행할 수 있습니다.  
실험에 사용된 **하이퍼파라미터/설정**은 코드에 명시되어 있으며, 평가에 필요한 **데이터셋/가중치 링크**를 함께 제공하여 **Reproducibility**를 보장합니다.

---

## Main Library
- PyTorch
- Diffusers
- Transformers
- pandas

---

## 폴더 구성
```text
datasets/
├─ coco_30k_10k.csv                     # target concept 제거 후 유틸리티 보존 성능 평가용 프롬프트
├─ i2p.csv                              # nudity 삭제 성능 평가 프롬프트
└─ mma-diffusion-nsfw-adv-prompts.csv   # Adversarial Attack 평가 프롬프트

infer/
├─ adv_sampling.py                      # nudity 삭제 모델 이미지 샘플링
├─ coco_sampling.py                     # COCO 유틸리티 보존 성능용 이미지 샘플링
└─ unlearncanvas-sampling.py            # style 삭제 모델 이미지 샘플링

eval/
├─ clip_similarity.py                   # 프롬프트–이미지 CLIP 유사도 평가
├─ compute_nudity_rate.py               # NudeNet 기반 nudity 제거 정확도 평가
├─ fid.py                               # FID 계산
├─ nudity_eval.py                       # nudity 평가 유틸리티
├─ unlearncanvas-acc.py                 # 스타일 삭제 성능 평가(분류기 사용)
└─ unlearncanvas-acc-result.py          # UA/IRA/CRA 결과 집계(Accuracy.json 저장)
```
---


## 메트릭

- FID: Fréchet Inception Distance between generated and original COCO images
- CLIP Similarity: cosine similarity between prompt embedding and generated image embedding
- UA: Accuracy of removing target concept
- IRA: Accuracy of retaining in-domain samples
- CRA: Accuracy of retaining cross-domain samples

---

참고 (Reproducibility Tip)

- 동일 환경을 위해 2_setup 스크립트를 사용하거나, Docker/conda 환경을 고정하는 것을 권장합니다.

- 샘플 출력/결과(JSON, 수치) 경로 규칙을 지켜 저장하면 평가 재현이 쉬워집니다.


--- 

## 추론 
- Args
  - ckpt
    - trained model checkpoint path
  - save_path
    - output directory
  - data_path
    - prompt CSV path
      
- requirement
  - [1_language](https://github.com/Coffeeloveman/technical-portfolio/tree/main/1_language)에서 학습한 text encoder weight

- nudity sampling
```
python infer/adv_sampling.py --ckpt "/path/to/the/ckpt" --save_path "/path/to/save/generated/images" --data_path "/path/to/prompt/file"
```
- style sampling
```
python infer/unlearncanvas-sampling.py --target_concept "Van Gogh" --ckpt "/path/to/the/ckpt" --pipe_dir "/path/to/the/canvas/fine-tuned/on/UnlearnCanvas" --save_path "/path/to/save/the/images"
```
- COCO sampling
```
python infer/coco_sampling.py --model_path "/path/to/the/ckpt/of/the/erased/nudity/model" --save_path "/path/to/save/generated/images"
```

## 평가

- requirement
  - [NudeNet Detector](https://github.com/notAI-tech/NudeNet/releases/download/v3.4-weights/320n.onnx)
  - [style_ckpt](https://drive.google.com/drive/folders/1AoazlvDgWgc3bAyHDpqlafqltmn4vm61)
  - 이미지 폴더

- nudity 평가
```
python eval/compute_nudity_rate.py --root "path/to/the/generated/images"
```
- style 평가
  - First, the images generated by the model with the target concept erased are classified using a classifier trained on the UnlearnCanvas dataset through the code below.
  - Then, UA (Unlearning Accuracy), IRA (In-Domain Retain Accuracy), and CRA (Cross-Domain Retain Accuracy) are computed through the code below.
```
python eval/unlearncanvas-acc.py --target_concept "Van Gogh" --input_dir "/path/to/the/generated/images" --save_path "/path/to/save/file" --style_ckpt "/path/to/the/style50_cls.pth" --object_ckpt "/path/to/the/style50.pth"
```
```
python eval/unlearncanvas-acc-result.py --target_concept "Van Gogh" --eval_type "style"  --eval_path "/path/to/the/saved/file" --save_path "/path/to/save/results"
```
- COCO 평가
  - To evaluate the retention performance of our proposed method, we computed the FID score and CLIP score on the COCO_30k_10k dataset using a SD1.4 from which nudity had been erased.

```
python eval/fid.py --img_dir "/path/to/the/generated/images" --orig_dir "/path/to/the/generated/images/with/SD1.4"
```
```
python eval/clip_similarity.py --image_folder_path "/path/to/the/generated/images" --csv_file_path "/path/to/the/COCO_30k_10k.csv" 
```
